# å¤æ‚å•æ®å¯¼å…¥å®Œæ•´æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-01-23  
**ç‰ˆæœ¬**: 2.0  
**çŠ¶æ€**: âœ… **è®¾è®¡å®Œæˆï¼Œå¾…Lovableå®æ–½**

**æ–‡æ¡£è¯´æ˜**: æœ¬æ–‡æ¡£æ•´åˆäº†å¤æ‚å•æ®å¯¼å…¥çš„æ‰€æœ‰è®¾è®¡å†…å®¹ï¼ŒåŒ…æ‹¬æ™ºèƒ½å­—æ®µæ˜ å°„ã€æ ¼å¼å¤„ç†ã€ä¸»æ•°æ®åŒ¹é…ã€ä¸‰é˜¶æ®µå¯¼å…¥æµç¨‹å’Œåˆ†å·¥ç­–ç•¥ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ™ºèƒ½å­—æ®µæ˜ å°„](#2-æ™ºèƒ½å­—æ®µæ˜ å°„)
3. [å¤æ‚å•æ®æ ¼å¼å¤„ç†](#3-å¤æ‚å•æ®æ ¼å¼å¤„ç†)
4. [ä¸»æ•°æ®åŒ¹é…å’Œç”¨æˆ·å†³ç­–](#4-ä¸»æ•°æ®åŒ¹é…å’Œç”¨æˆ·å†³ç­–)
5. [ä¸‰é˜¶æ®µå¯¼å…¥æµç¨‹](#5-ä¸‰é˜¶æ®µå¯¼å…¥æµç¨‹)
6. [æŠ€æœ¯åˆ†å·¥ç­–ç•¥](#6-æŠ€æœ¯åˆ†å·¥ç­–ç•¥)
7. [APIæ¥å£è®¾è®¡](#7-apiæ¥å£è®¾è®¡)
8. [æ•°æ®åº“è®¾è®¡](#8-æ•°æ®åº“è®¾è®¡)
9. [æ€»ç»“å’Œå®æ–½å»ºè®®](#9-æ€»ç»“å’Œå®æ–½å»ºè®®)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

å¤æ‚å•æ®å¯¼å…¥ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ™ºèƒ½åŒ–çš„æ•°æ®å¯¼å…¥è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

1. âœ… **æ™ºèƒ½å­—æ®µæ˜ å°„**ï¼šè‡ªåŠ¨æ¨èå­—æ®µæ˜ å°„ï¼Œè®°å½•å†å²æ˜ å°„ï¼ŒæŒç»­å­¦ä¹ æé«˜å‡†ç¡®æ€§
2. âœ… **æ ¼å¼è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«6ç§å¤æ‚å•æ®æ ¼å¼ï¼ˆå¸¸è§æ ¼å¼ä¼˜å…ˆï¼‰
3. âœ… **ä¸»æ•°æ®åŒ¹é…**ï¼šè‡ªåŠ¨åŒ¹é…7ç§ä¸»æ•°æ®IDï¼ˆç»è¥ä¸»ä½“ã€å¾€æ¥å•ä½ã€äº§å“ã€è®¡é‡å•ä½ã€ç¨ç‡ã€å‘˜å·¥ã€æ±‡ç‡ï¼‰
4. âœ… **ç”¨æˆ·å†³ç­–æœºåˆ¶**ï¼šåœ¨å…³é”®å†³ç­–ç‚¹æ”¯æŒç”¨æˆ·é€‰æ‹©ï¼ˆé€‰æ‹©åŒ¹é…ã€åˆ›å»ºæ–°ã€åºŸå¼ƒï¼‰
5. âœ… **ä¸‰é˜¶æ®µå¯¼å…¥**ï¼šä¸´æ—¶è¡¨éš”ç¦»ã€é—®é¢˜ä¿®æ­£ã€æ­£å¼è¡¨å¯¼å…¥

### 1.2 å¯¼å…¥æµç¨‹æ¦‚è§ˆ

```
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
    â†“
ã€é˜¶æ®µ1ã€‘å­—æ®µæ˜ å°„ï¼ˆæ™ºèƒ½æ¨è + å†å²è®°å¿†ï¼‰
    â†“
ã€é˜¶æ®µ2ã€‘æ ¼å¼è¯†åˆ«å’Œå¤„ç†ï¼ˆ6ç§æ ¼å¼è‡ªåŠ¨è¯†åˆ«ï¼‰
    â†“
ã€é˜¶æ®µ3ã€‘ä¸»æ•°æ®åŒ¹é…ï¼ˆè‡ªåŠ¨åŒ¹é… + ç”¨æˆ·å†³ç­–ï¼‰
    â†“
ã€é˜¶æ®µ4ã€‘å¯¼å…¥ä¸´æ—¶è¡¨ï¼ˆstaging_document_importï¼‰
    â†“
ã€é˜¶æ®µ5ã€‘ç”¨æˆ·ä¿®æ­£ï¼ˆæ‰¹é‡/é€æ¡å¤„ç†é—®é¢˜ï¼‰
    â†“
ã€é˜¶æ®µ6ã€‘å¯¼å…¥æ­£å¼è¡¨ï¼ˆéªŒè¯åå¯¼å…¥ï¼‰
```

---

## 2. æ™ºèƒ½å­—æ®µæ˜ å°„

### 2.1 æ ¸å¿ƒéœ€æ±‚

åœ¨æ•°æ®å¯¼å…¥æ—¶ï¼Œç”¨æˆ·æä¾›çš„æºæ–‡ä»¶æ ¼å¼ã€å­—æ®µåç§°ä¼šå‡ºç°å˜åŒ–ï¼Œä½†æœ‰ä¸€å®šç¨³å®šæ€§ã€‚å› æ­¤éœ€è¦ï¼š

1. âœ… **æ™ºèƒ½æ¨è**ï¼šè‡ªåŠ¨æ¨èå­—æ®µæ˜ å°„å…³ç³»ï¼Œé™ä½ç”¨æˆ·æ“ä½œéš¾åº¦
2. âœ… **å†å²è®°å¿†**ï¼šè®°å½•å†å²æ˜ å°„è®°å½•ï¼Œä½œä¸ºä¸‹æ¬¡æ™ºèƒ½æ˜ å°„çš„å‚è€ƒ
3. âœ… **æŒç»­å­¦ä¹ **ï¼šç”¨æˆ·ç¡®è®¤çš„æ˜ å°„ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œæé«˜åç»­æ¨èçš„å‡†ç¡®æ€§
4. âœ… **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè€ƒè™‘æ•°æ®æºç±»å‹ã€å•æ®ç±»å‹ã€ç”¨æˆ·IDç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯

### 2.2 æ˜ å°„ä¼˜å…ˆçº§

1. **å†å²æ˜ å°„**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ï¼šåŒä¸€æ•°æ®æºã€åŒä¸€å•æ®ç±»å‹çš„å†å²æ˜ å°„ï¼Œç½®ä¿¡åº¦æœ€é«˜ï¼ˆ0.85-1.0ï¼‰
2. **ç³»ç»Ÿè§„åˆ™**ï¼šç³»ç»Ÿçº§æ˜ å°„è§„åˆ™ï¼ˆå¦‚æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼‰ï¼Œç½®ä¿¡åº¦é«˜ï¼ˆ0.9ï¼‰
3. **ç›¸ä¼¼åº¦åŒ¹é…**ï¼šå­—ç¬¦ä¸²ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆSequenceMatcherã€åŒ…å«å…³ç³»ã€å­—ç¬¦äº¤é›†ï¼‰ï¼Œç½®ä¿¡åº¦ä¸­ç­‰ï¼ˆ0.6-0.9ï¼‰

### 2.3 æ˜ å°„æ¨èç®—æ³•

```python
class IntelligentFieldMapper:
    """æ™ºèƒ½å­—æ®µæ˜ å°„å™¨"""
    
    def recommend_mappings(
        self,
        source_fields: List[str],
        source_system: str,
        document_type: Optional[str] = None,
        user_id: Optional[str] = None
    ) -> List[FieldMappingRecommendation]:
        """æ¨èå­—æ®µæ˜ å°„"""
        recommendations = []
        
        for source_field in source_fields:
            candidates = []
            
            # 1. æŸ¥è¯¢å†å²æ˜ å°„ï¼ˆä¼˜å…ˆï¼‰
            history_candidates = self._get_history_mappings(
                source_field, source_system, document_type, user_id
            )
            candidates.extend(history_candidates)
            
            # 2. åº”ç”¨æ˜ å°„è§„åˆ™
            rule_candidates = self._apply_mapping_rules(
                source_field, source_system, document_type
            )
            candidates.extend(rule_candidates)
            
            # 3. è®¡ç®—ç›¸ä¼¼åº¦åŒ¹é…
            if not candidates or max(c.confidence for c in candidates) < 0.8:
                similarity_candidates = self._calculate_similarity_mappings(
                    source_field, document_type
                )
                candidates.extend(similarity_candidates)
            
            # 4. æ’åºå’Œå»é‡
            candidates = self._deduplicate_and_sort_candidates(candidates)
            
            recommendations.append(FieldMappingRecommendation(
                source_field=source_field,
                candidates=candidates,
                recommended_target=candidates[0].target_field if candidates else None,
                recommended_confidence=candidates[0].confidence if candidates else 0.0
            ))
        
        return recommendations
```

### 2.4 æ•°æ®åº“è®¾è®¡

```sql
-- å­—æ®µæ˜ å°„å†å²è®°å½•è¡¨
CREATE TABLE field_mapping_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ä¸Šä¸‹æ–‡ä¿¡æ¯
    source_system VARCHAR(50) NOT NULL,
    document_type VARCHAR(50),
    user_id UUID,
    
    -- æºå­—æ®µä¿¡æ¯
    source_field_name VARCHAR(255) NOT NULL,
    target_field_name VARCHAR(255) NOT NULL,
    
    -- åŒ¹é…ä¿¡æ¯
    match_confidence DECIMAL(5,2),
    match_method VARCHAR(50),  -- history, similarity, rule, manual
    
    -- ä½¿ç”¨ç»Ÿè®¡
    usage_count INTEGER DEFAULT 1,
    last_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    first_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç”¨æˆ·åé¦ˆ
    is_confirmed BOOLEAN DEFAULT TRUE,
    is_rejected BOOLEAN DEFAULT FALSE,
    
    -- å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_mapping UNIQUE (source_system, document_type, source_field_name, target_field_name, user_id)
);

-- å­—æ®µæ˜ å°„è§„åˆ™è¡¨ï¼ˆç³»ç»Ÿçº§è§„åˆ™ï¼‰
CREATE TABLE field_mapping_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- è§„åˆ™æ¡ä»¶
    source_system VARCHAR(50),
    document_type VARCHAR(50),
    
    -- åŒ¹é…æ¨¡å¼
    source_pattern VARCHAR(255) NOT NULL,
    match_type VARCHAR(50) DEFAULT 'exact',  -- exact, prefix, suffix, regex, contains
    
    -- ç›®æ ‡å­—æ®µ
    target_field_name VARCHAR(255) NOT NULL,
    
    -- ä¼˜å…ˆçº§
    priority INTEGER DEFAULT 100,
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 3. å¤æ‚å•æ®æ ¼å¼å¤„ç†

### 3.1 å•æ®æ ¼å¼ç±»å‹

æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯ï¼Œç³»ç»Ÿéœ€è¦å¤„ç†ä»¥ä¸‹6ç§å¤æ‚çš„å•æ®æ ¼å¼ï¼š

#### æ ¼å¼1: å¤šè¡Œæ˜ç»†å¯¹åº”é‡å¤å•æ®å¤´ âœ… **å¸¸è§æ ¼å¼**

```
å•æ®å· | å•æ®æ—¥æœŸ | å®¢æˆ·åç§° | äº§å“åç§° | æ•°é‡ | å•ä»· | ä¸å«ç¨é‡‘é¢ | ç¨é¢ | ä»·ç¨åˆè®¡
DOC001 | 2024-01-01 | å®¢æˆ·A | äº§å“1 | 10 | 100.00 | 1000.00 | 130.00 | 1130.00
DOC001 | 2024-01-01 | å®¢æˆ·A | äº§å“2 | 5  | 100.00 | 500.00  | 65.00  | 565.00
DOC002 | 2024-01-02 | å®¢æˆ·B | äº§å“3 | 8  | 100.00 | 800.00  | 104.00 | 904.00
```
**ç‰¹ç‚¹**ï¼šæ¯è¡Œéƒ½åŒ…å«å®Œæ•´çš„å•æ®å¤´ä¿¡æ¯å’Œæ˜ç»†ä¿¡æ¯ã€‚  
**åœºæ™¯**ï¼šæœ€å¸¸è§çš„å•æ®æ ¼å¼ï¼ŒERPç³»ç»Ÿå¯¼å‡ºæ ‡å‡†æ ¼å¼ã€‚

#### æ ¼å¼2: å¤šè¡Œæ˜ç»†ä½†åªæœ‰ç¬¬ä¸€è¡Œæœ‰å•æ®å¤´ âœ… **å¸¸è§æ ¼å¼**

```
å•æ®å· | å•æ®æ—¥æœŸ | å®¢æˆ·åç§° | äº§å“åç§° | æ•°é‡ | å•ä»· | ä¸å«ç¨é‡‘é¢ | ç¨é¢ | ä»·ç¨åˆè®¡
DOC001 | 2024-01-01 | å®¢æˆ·A | äº§å“1 | 10 | 100.00 | 1000.00 | 130.00 | 1130.00
       |           |        | äº§å“2 | 5  | 100.00 | 500.00  | 65.00  | 565.00
       |           |        | äº§å“3 | 3  | 100.00 | 300.00  | 39.00  | 339.00
DOC002 | 2024-01-02 | å®¢æˆ·B | äº§å“4 | 8  | 100.00 | 800.00  | 104.00 | 904.00
```
**ç‰¹ç‚¹**ï¼šç¬¬ä¸€è¡ŒåŒ…å«å•æ®å¤´ä¿¡æ¯ï¼Œåç»­æ˜ç»†è¡Œçš„å•æ®å¤´å­—æ®µä¸ºç©ºï¼Œéœ€è¦é€šè¿‡å‰å‘å¡«å……è¡¥å…¨ã€‚  
**åœºæ™¯**ï¼šExcelè¡¨æ ¼å¸¸è§çš„ç´§å‡‘æ ¼å¼ï¼Œå‡å°‘é‡å¤ä¿¡æ¯ã€‚

#### æ ¼å¼3: å•æ®å¤´å’Œæ˜ç»†åˆ†ç¦»åœ¨ä¸åŒè¡¨ âŒ **å¯å¿½ç•¥æ ¼å¼**

**è¯´æ˜**ï¼šè¯¥æ ¼å¼åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­è¾ƒå°‘å‡ºç°ï¼Œå¯ä»¥å¿½ç•¥ã€‚å¦‚æœç¡®å®éœ€è¦æ”¯æŒï¼Œå¯ä»¥é€šè¿‡åˆ†ä¸¤æ¬¡å¯¼å…¥ï¼ˆå…ˆå¯¼å…¥å•æ®å¤´ï¼Œå†å¯¼å…¥æ˜ç»†ï¼‰æ¥å®ç°ã€‚

#### æ ¼å¼4: åªæœ‰å•æ®å¤´è®°å½• âœ… **å¸¸è§æ ¼å¼**

```
å•æ®å· | å•æ®æ—¥æœŸ | å®¢æˆ·åç§° | ä¸å«ç¨é‡‘é¢ | ç¨é¢ | ä»·ç¨åˆè®¡ | å¤‡æ³¨
DOC001 | 2024-01-01 | å®¢æˆ·A | 1800.00 | 234.00 | 2034.00 | æ±‡æ€»å•æ®
```
**ç‰¹ç‚¹**ï¼šåªæœ‰å•æ®å¤´ä¿¡æ¯ï¼Œæ²¡æœ‰æ˜ç»†ã€‚å…è®¸ç”¨æˆ·é€‰æ‹©å¯¼å…¥ï¼Œåç»­å¯è¡¥å……æ˜ç»†è®°å½•ã€‚  
**åœºæ™¯**ï¼šæ±‡æ€»å•æ®ã€æœåŠ¡ç±»å•æ®ã€æˆ–ç”¨æˆ·é€‰æ‹©å¯¼å…¥æ±‡æ€»æ•°æ®åè¡¥å……æ˜ç»†ã€‚

#### æ ¼å¼5: åªæœ‰æ˜ç»†è®°å½• âš ï¸ **ç‰¹æ®Šåœºæ™¯æ ¼å¼**

```
å•æ®å· | äº§å“åç§° | æ•°é‡ | å•ä»· | ä¸å«ç¨é‡‘é¢ | ç¨é¢ | ä»·ç¨åˆè®¡
DOC001 | äº§å“1 | 10 | 100.00 | 1000.00 | 130.00 | 1130.00
DOC001 | äº§å“2 | 5  | 100.00 | 500.00  | 65.00  | 565.00
DOC002 | äº§å“3 | 3  | 100.00 | 300.00  | 39.00  | 339.00
```
**ç‰¹ç‚¹**ï¼šåªæœ‰æ˜ç»†ä¿¡æ¯ï¼Œä½†åŒ…å«å•æ®å·å­—æ®µï¼Œç”¨äºå…³è”ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„å•æ®å¤´è®°å½•ã€‚  
**åœºæ™¯**ï¼šä¸»è¦ç”¨äº**ç”¨æˆ·è¡¥å……æ˜ç»†æ•°æ®æ—¶**ï¼Œå½“ç³»ç»Ÿä¸­å·²å­˜åœ¨å•æ®å¤´è®°å½•ï¼ˆå¯èƒ½ä¹‹å‰é€šè¿‡æ ¼å¼4å¯¼å…¥ï¼‰ï¼Œç°åœ¨éœ€è¦è¡¥å……å¯¹åº”çš„æ˜ç»†è¡Œæ•°æ®ã€‚

**å…³é”®å¤„ç†é€»è¾‘**ï¼š
1. âœ… ç³»ç»Ÿé€šè¿‡æ˜ç»†è®°å½•ä¸­çš„**å•æ®å·**å­—æ®µï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾å·²å­˜åœ¨çš„å•æ®å¤´è®°å½•ID
2. âœ… å¦‚æœæ‰¾åˆ°åŒ¹é…çš„å•æ®å¤´è®°å½•ï¼Œå°†æ˜ç»†è®°å½•ä¸å•æ®å¤´IDå…³è”
3. âœ… å¦‚æœæœªæ‰¾åˆ°åŒ¹é…çš„å•æ®å¤´è®°å½•ï¼Œéœ€è¦ç”¨æˆ·å†³ç­–ï¼š
   - **é€‰æ‹©**ï¼šé€‰æ‹©ç³»ç»Ÿä¸­æŸä¸ªç›¸ä¼¼çš„å•æ®å¤´ï¼ˆå¦‚æœæœ‰ï¼‰
   - **åˆ›å»ºæ–°**ï¼šåˆ›å»ºæ–°çš„å•æ®å¤´è®°å½•
   - **åºŸå¼ƒ**ï¼šè·³è¿‡è¯¥æ˜ç»†è®°å½•ï¼Œä¸å¯¼å…¥

#### æ ¼å¼6: çº¯å•æ®å¤´è®°å½•ï¼ˆæ— æ˜ç»†ï¼‰ âœ… **å¸¸è§æ ¼å¼**

```
å•æ®å· | å•æ®æ—¥æœŸ | å®¢æˆ·åç§° | ä¸å«ç¨é‡‘é¢ | ç¨é¢ | ä»·ç¨åˆè®¡ | å•æ®ç±»å‹ | å¤‡æ³¨
DOC001 | 2024-01-01 | å®¢æˆ·A | 1800.00 | 234.00 | 2034.00 | æœåŠ¡è´¹ | å’¨è¯¢æœåŠ¡
DOC002 | 2024-01-02 | å®¢æˆ·B | 500.00  | 65.00  | 565.00  | æœåŠ¡è´¹ | æŠ€æœ¯æ”¯æŒ
DOC003 | 2024-01-03 | å®¢æˆ·C | 1200.00 | 156.00 | 1356.00 | æœåŠ¡è´¹ | åŸ¹è®­æœåŠ¡
```
**ç‰¹ç‚¹**ï¼šçº¯å•æ®å¤´è®°å½•ï¼Œæ— æ˜ç»†ï¼Œç›´æ¥ä½¿ç”¨ã€‚  
**åœºæ™¯**ï¼šæœåŠ¡è´¹ã€å’¨è¯¢è´¹ã€åŸ¹è®­è´¹ç­‰æ— æ˜ç»†çš„æœåŠ¡ç±»å•æ®ã€‚æ¯æ¡è®°å½•éƒ½æ˜¯ç‹¬ç«‹çš„å•æ®ï¼Œä¸éœ€è¦æ˜ç»†ä¿¡æ¯ã€‚

### 3.2 æ ¼å¼è¯†åˆ«ç®—æ³•

```python
class DocumentFormatDetector:
    """å•æ®æ ¼å¼è¯†åˆ«å™¨"""
    
    def detect_format(self, data: pd.DataFrame, metadata: dict = None) -> str:
        """æ£€æµ‹å•æ®æ ¼å¼"""
        scores = {}
        
        for format_name, detector_func in self.format_patterns.items():
            score = detector_func(data, metadata)
            scores[format_name] = score
        
        # è¿”å›å¾—åˆ†æœ€é«˜çš„æ ¼å¼
        return max(scores, key=scores.get)
    
    def detect_repeated_header(self, data: pd.DataFrame, metadata: dict = None) -> float:
        """æ£€æµ‹é‡å¤å•æ®å¤´æ ¼å¼ï¼ˆæ ¼å¼1ï¼‰"""
        # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å•æ®å·
        if 'å•æ®å·' in data.columns:
            unique_docs = data['å•æ®å·'].nunique()
            total_rows = len(data)
            
            if unique_docs < total_rows * 0.8:
                return 0.9  # é«˜ç½®ä¿¡åº¦
        return 0.0
    
    def detect_first_row_header(self, data: pd.DataFrame, metadata: dict = None) -> float:
        """æ£€æµ‹ç¬¬ä¸€è¡Œå•æ®å¤´æ ¼å¼ï¼ˆæ ¼å¼2ï¼‰"""
        if len(data) > 1:
            second_row = data.iloc[1]
            empty_count = second_row.isna().sum()
            total_cols = len(second_row)
            
            if empty_count > total_cols * 0.3:
                return 0.8  # é«˜ç½®ä¿¡åº¦
        return 0.0
```

### 3.3 å¤„ç†æµç¨‹

```
1. è§£ææºæ–‡ä»¶
   â†“
2. å­—æ®µæ˜ å°„ï¼ˆå°†æºå­—æ®µæ˜ å°„åˆ°æ ‡å‡†å­—æ®µåï¼‰
   â†“
3. æ ¼å¼è¯†åˆ«ï¼ˆè‡ªåŠ¨æ£€æµ‹6ç§æ ¼å¼ï¼‰
   â†“
4. åº”ç”¨æ ¼å¼å¤„ç†
   â”œâ”€â”€ æ ¼å¼1ï¼šç›´æ¥ä½¿ç”¨
   â”œâ”€â”€ æ ¼å¼2ï¼šå‰å‘å¡«å……å•æ®å¤´å­—æ®µ
   â”œâ”€â”€ æ ¼å¼4ï¼šåˆ›å»ºè™šæ‹Ÿæ˜ç»†è®°å½•
   â”œâ”€â”€ æ ¼å¼5ï¼šåŒ¹é…å•æ®å¤´ID
   â””â”€â”€ æ ¼å¼6ï¼šç›´æ¥ä½¿ç”¨
   â†“
5. æ•°æ®éªŒè¯å’Œæ¸…æ´—
   â†“
6. å‡†å¤‡å¯¼å…¥ä¸´æ—¶è¡¨
```

---

## 4. ä¸»æ•°æ®åŒ¹é…å’Œç”¨æˆ·å†³ç­–

### 4.1 ä¸»æ•°æ®ç±»å‹

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹7ç§ä¸»æ•°æ®IDçš„è‡ªåŠ¨åŒ¹é…ï¼š

| ä¸»æ•°æ®ç±»å‹ | åŒ¹é…å­—æ®µ | åŒ¹é…è¡¨ | åŒ¹é…ç±»å‹ |
|-----------|---------|--------|---------|
| ç»è¥ä¸»ä½“ID | ç»è¥ä¸»ä½“åç§°ã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç  | dim_business_entity | å•å­—æ®µåŒ¹é…ï¼ˆä¼˜å…ˆä»£ç ï¼‰ |
| å¾€æ¥å•ä½ID | å¾€æ¥å•ä½åç§°ã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç  | dim_counterparty | å•å­—æ®µåŒ¹é…ï¼ˆä¼˜å…ˆä»£ç ï¼‰ |
| äº§å“ID | äº§å“åç§°ã€è§„æ ¼å‹å· | dim_product | ç»„åˆåŒ¹é…ï¼ˆåç§°+è§„æ ¼ï¼‰ |
| è®¡é‡å•ä½ID | è®¡é‡å•ä½åç§° | dim_unit | å•å­—æ®µåŒ¹é… |
| ç¨ç‡ID | ç¨ç‡å€¼ã€ç¨ç‡åç§° | dim_tax_rate | å•å­—æ®µåŒ¹é… |
| å‘˜å·¥ID | å‘˜å·¥å§“åã€å‘˜å·¥å·¥å·ã€èº«ä»½è¯å· | dim_employee | å•å­—æ®µåŒ¹é…ï¼ˆä¼˜å…ˆå·¥å·ï¼‰ |
| æ±‡ç‡ID | å¸ç§ã€æ±‡ç‡æ—¥æœŸã€æ±‡ç‡å€¼ | dim_exchange_rate | ç»„åˆåŒ¹é…ï¼ˆå¸ç§+æ—¥æœŸï¼‰ |

### 4.2 åŒ¹é…ç®—æ³•

```python
def match_master_data_ids(
    self,
    data: pd.DataFrame,
    master_data_config: Dict[str, Any],
    db_connection=None
) -> Dict[str, Any]:
    """åŒ¹é…ä¸»æ•°æ®ID"""
    
    for master_type, rule in master_data_rules.items():
        id_field = rule['id_field']
        match_fields = rule['match_fields']
        priority = rule.get('priority', [])
        match_type = rule.get('match_type', 'single')
        
        for idx, row in data.iterrows():
            match_results = []
            
            # æŒ‰ä¼˜å…ˆçº§å°è¯•åŒ¹é…
            for priority_field in priority:
                # æ‰§è¡ŒåŒ¹é…æŸ¥è¯¢
                if match_type == 'combined':
                    match_result = self._match_combined_fields(row, match_fields, rule, db_connection)
                else:
                    match_result = self._match_single_field(source_value, match_field_config, db_connection)
                
                if match_result:
                    match_results.append({
                        **match_result,
                        'confidence': self._calculate_confidence(match_result, priority_field)
                    })
            
            # å¤„ç†åŒ¹é…ç»“æœ
            if len(match_results) == 0:
                # æœªæ‰¾åˆ°åŒ¹é…ï¼Œéœ€è¦ç”¨æˆ·å†³ç­–
                raise ValueError("éœ€è¦ç”¨æˆ·å†³ç­–ï¼šé€‰æ‹©åŒ¹é…ã€åˆ›å»ºæ–°è®°å½•ã€æˆ–åºŸå¼ƒè¯¥è®°å½•")
            elif len(match_results) == 1:
                # å”¯ä¸€åŒ¹é…ï¼Œæ£€æŸ¥ç½®ä¿¡åº¦
                if match_result['confidence'] >= threshold:
                    data.at[idx, id_field] = match_result['id']
                else:
                    # ç½®ä¿¡åº¦ä½ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤
                    raise ValueError("éœ€è¦ç”¨æˆ·ç¡®è®¤åŒ¹é…ç»“æœ")
            else:
                # å¤šä¸ªåŒ¹é…ç»“æœï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
                raise ValueError("éœ€è¦ç”¨æˆ·é€‰æ‹©åŒ¹é…é¡¹")
```

### 4.3 ç”¨æˆ·å†³ç­–é€‰é¡¹

**ä¸»æ•°æ®åŒ¹é…å†³ç­–**ï¼š
1. **é€‰æ‹©**ï¼šé€‰æ‹©æŸä¸ªåŒ¹é…é¡¹ï¼ˆä»å¤šä¸ªå€™é€‰ä¸­é€‰æ‹©ï¼‰
2. **åˆ›å»ºæ–°**ï¼šåˆ›å»ºæ–°çš„ä¸»æ•°æ®è®°å½•å¹¶è‡ªåŠ¨åŒ¹é…
3. **åºŸå¼ƒ**ï¼šè·³è¿‡è¯¥è®°å½•ï¼Œä¸å¯¼å…¥

**å•æ®å¤´IDåŒ¹é…å†³ç­–**ï¼ˆæ ¼å¼5è¡¥å……æ˜ç»†æ—¶ï¼‰ï¼š
1. **é€‰æ‹©**ï¼šé€‰æ‹©ç³»ç»Ÿä¸­æŸä¸ªç›¸ä¼¼çš„å•æ®å¤´
2. **åˆ›å»ºæ–°**ï¼šåˆ›å»ºæ–°çš„å•æ®å¤´è®°å½•
3. **åºŸå¼ƒ**ï¼šè·³è¿‡è¯¥æ˜ç»†è®°å½•ï¼Œä¸å¯¼å…¥

### 4.4 è®¡ç®—å­—æ®µå†²çªçº æ­£

**å¸¸è§å†²çª**ï¼š
- ä»·ç¨åˆè®¡ â‰  ä¸å«ç¨é‡‘é¢ + ç¨é¢

**çº æ­£ç­–ç•¥**ï¼š
1. ä¼˜å…ˆä¿¡ä»»ï¼šä»·ç¨åˆè®¡ = ä¸å«ç¨é‡‘é¢ + ç¨é¢ï¼ˆå¦‚æœä»·ç¨åˆè®¡å‡†ç¡®ï¼‰
2. ç”¨æˆ·é€‰æ‹©ï¼šç”¨æˆ·é€‰æ‹©ä¿¡ä»»å“ªä¸ªå­—æ®µ
3. è‡ªåŠ¨ä¿®æ­£ï¼šæ ¹æ®ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨ä¿®æ­£

---

## 5. ä¸‰é˜¶æ®µå¯¼å…¥æµç¨‹

### 5.1 ä¸ºä»€ä¹ˆä½¿ç”¨ä¸‰é˜¶æ®µå¯¼å…¥ï¼Ÿ

1. âœ… **æ•°æ®å®‰å…¨**ï¼šä¸´æ—¶è¡¨éš”ç¦»é”™è¯¯æ•°æ®ï¼Œé¿å…å½±å“æ­£å¼ä¸šåŠ¡æ•°æ®
2. âœ… **é”™è¯¯å¤„ç†**ï¼šåœ¨ä¸´æ—¶è¡¨ä¸­æ‰¹é‡ä¿®æ­£é—®é¢˜ï¼Œæ›´çµæ´»ã€æ›´å®‰å…¨
3. âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šå¯ä»¥åœ¨ä¸´æ—¶è¡¨ä¸­é¢„è§ˆå’ŒéªŒè¯ï¼Œæé«˜æ•°æ®è´¨é‡
4. âœ… **ä¸šåŠ¡æµç¨‹**ï¼šé€‚åˆéœ€è¦å®¡æ ¸ã€åä½œçš„ä¸šåŠ¡åœºæ™¯
5. âœ… **ç³»ç»Ÿæ€§èƒ½**ï¼šå‡å°‘æ­£å¼è¡¨çš„å†™æ“ä½œå’Œé”ç«äº‰

### 5.2 é˜¶æ®µ1ï¼šå¯¼å…¥ä¸´æ—¶è¡¨

**ç›®æ ‡**ï¼š
- å¿«é€Ÿæ¥æ”¶å¯¼å…¥æ•°æ®
- ä¿ç•™åŸå§‹æ•°æ®
- è®°å½•å¯¼å…¥æ‰¹æ¬¡ä¿¡æ¯
- æ ‡è®°é—®é¢˜æ•°æ®

**æµç¨‹**ï¼š
```
1. æ•°æ®å»é‡å’Œé¢„å¤„ç†
2. å¯¼å…¥ä¸´æ—¶è¡¨ï¼ˆstaging_document_importï¼‰
3. è‡ªåŠ¨åŒ¹é…ä¸»æ•°æ®ï¼ˆé«˜ç½®ä¿¡åº¦è‡ªåŠ¨åŒ¹é…ï¼‰
4. æ ‡è®°é—®é¢˜æ•°æ®ï¼š
   - ä½ç½®ä¿¡åº¦åŒ¹é…
   - åŒ¹é…å¤±è´¥
   - è®¡ç®—å†²çªï¼ˆä»·ç¨åˆè®¡ â‰  ä¸å«ç¨é‡‘é¢ + ç¨é¢ï¼‰
5. çŠ¶æ€æ ‡è®°ï¼špending â†’ matched/problem
```

**ä¸´æ—¶è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE staging_document_import (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- å¯¼å…¥æ‰¹æ¬¡ä¿¡æ¯
    batch_id UUID NOT NULL,
    import_user_id UUID,
    import_source VARCHAR(100),
    import_file_name VARCHAR(255),
    import_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- åŸå§‹æ•°æ®å­—æ®µï¼ˆä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µï¼‰
    document_number VARCHAR(100),
    document_date DATE,
    customer_name VARCHAR(255),
    product_name VARCHAR(255),
    quantity DECIMAL(18,2),
    unit_price DECIMAL(18,2),
    amount_excluding_tax DECIMAL(18,2),
    tax_amount DECIMAL(18,2),
    total_amount_with_tax DECIMAL(18,2),
    
    -- åŒ¹é…åçš„å­—æ®µ
    business_entity_id UUID,
    counterparty_id UUID,
    product_id UUID,
    unit_id UUID,
    tax_rate_id UUID,
    employee_id UUID,
    exchange_rate_id UUID,
    document_header_id UUID,  -- æ ¼å¼5è¡¥å……æ˜ç»†æ—¶
    
    -- é—®é¢˜æ ‡è®°å’ŒçŠ¶æ€
    status VARCHAR(50) DEFAULT 'pending',  -- pending, matched, problem, confirmed, imported
    problem_type VARCHAR(50),  -- no_master_match, multiple_match, calculation_conflict
    problem_description TEXT,
    requires_user_action BOOLEAN DEFAULT FALSE,
    
    -- ç”¨æˆ·å†³ç­–ä¿¡æ¯
    user_action VARCHAR(50),  -- select, create_new, skip, fixed
    user_action_details JSONB,
    user_action_timestamp TIMESTAMP,
    handled_by_user_id UUID,
    
    -- æ•°æ®è´¨é‡è¯„åˆ†
    quality_score DECIMAL(5,2),
    validation_errors JSONB,
    
    -- åŸå§‹è¡Œæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
    raw_data_json JSONB,
    row_number INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_staging_batch (batch_id),
    INDEX idx_staging_status (status),
    INDEX idx_staging_requires_action (requires_user_action)
);
```

### 5.3 é˜¶æ®µ2ï¼šç”¨æˆ·ä¿®æ­£

**ç”¨æˆ·æ“ä½œç•Œé¢**ï¼š

1. **é—®é¢˜åˆ—è¡¨è§†å›¾**
   - æ˜¾ç¤ºæ‰€æœ‰éœ€è¦å¤„ç†çš„é—®é¢˜æ•°æ®
   - æŒ‰é—®é¢˜ç±»å‹åˆ†ç»„ï¼ˆä¸»æ•°æ®åŒ¹é…ã€è®¡ç®—å†²çªç­‰ï¼‰
   - æ”¯æŒç­›é€‰å’Œæœç´¢

2. **æ‰¹é‡å¤„ç†åŠŸèƒ½**
   - æ‰¹é‡ç¡®è®¤æ¨¡ç³ŠåŒ¹é…
   - æ‰¹é‡åˆ›å»ºæ–°çš„ä¸»æ•°æ®è®°å½•
   - æ‰¹é‡åºŸå¼ƒè®°å½•
   - æ‰¹é‡ä¿®æ­£è®¡ç®—å­—æ®µå†²çª

3. **é€æ¡å¤„ç†åŠŸèƒ½**
   - æ˜¾ç¤ºåŸå§‹æ•°æ®å’ŒåŒ¹é…ç»“æœ
   - ç”¨æˆ·é€‰æ‹©ã€åˆ›å»ºã€åºŸå¼ƒæ“ä½œ
   - å®æ—¶é¢„è§ˆä¿®æ­£åçš„æ•°æ®

**å¤„ç†æµç¨‹**ï¼š
```
1. ç”¨æˆ·åœ¨ä¸´æ—¶è¡¨ä¸­å¤„ç†é—®é¢˜ï¼š
   - æ¨¡ç³ŠåŒ¹é…ç¡®è®¤ï¼ˆé€‰æ‹©ã€åˆ›å»ºæ–°ã€åºŸå¼ƒï¼‰
   - åˆ›å»ºæ–°çš„ä¸»æ•°æ®è®°å½•å¹¶è‡ªåŠ¨åŒ¹é…
   - åºŸå¼ƒé”™è¯¯è®°å½•
   - çº æ­£è®¡ç®—å­—æ®µå†²çªï¼ˆä»·ç¨åˆè®¡ = ä¸å«ç¨é‡‘é¢ + ç¨é¢ï¼‰
2. æ‰¹é‡æˆ–é€æ¡å¤„ç†
3. çŠ¶æ€æ›´æ–°ï¼šproblem â†’ confirmed
```

### 5.4 é˜¶æ®µ3ï¼šå¯¼å…¥æ­£å¼è¡¨

**è§¦å‘æ¡ä»¶**ï¼š
- æ‰€æœ‰é—®é¢˜å·²å¤„ç†ï¼ˆstatus = 'confirmed'ï¼‰
- ç”¨æˆ·æ‰‹åŠ¨è§¦å‘"ç¡®è®¤å¯¼å…¥"
- å®šæ—¶æ‰¹é‡å¯¼å…¥ï¼ˆå¯é€‰ï¼‰

**å¯¼å…¥é€»è¾‘**ï¼š
```sql
-- 1. éªŒè¯æ•°æ®å®Œæ•´æ€§
-- 2. å»é‡æ£€æŸ¥
-- 3. å¯¼å…¥æ­£å¼è¡¨
INSERT INTO doc_purchase_order_header (...)
SELECT ... FROM staging_document_import
WHERE batch_id = ? AND status = 'confirmed';

INSERT INTO doc_purchase_order_detail (...)
SELECT ... FROM staging_document_import
WHERE batch_id = ? AND status = 'confirmed';

-- 4. æ›´æ–°ä¸´æ—¶è¡¨çŠ¶æ€
UPDATE staging_document_import
SET status = 'imported', imported_at = CURRENT_TIMESTAMP
WHERE batch_id = ? AND status = 'confirmed';
```

### 5.5 ä¼˜åŒ–å»ºè®®

1. **ç®€åŒ–æ“ä½œ**ï¼šé«˜ç½®ä¿¡åº¦æ•°æ®è‡ªåŠ¨å¯¼å…¥æ­£å¼è¡¨ï¼Œåªå°†éœ€è¦å†³ç­–çš„æ•°æ®å¯¼å…¥ä¸´æ—¶è¡¨
2. **è‡ªåŠ¨æ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†7å¤©å‰çš„å·²å¯¼å…¥æ•°æ®ï¼Œ30å¤©å‰çš„åºŸå¼ƒæ•°æ®
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œã€ç´¢å¼•ä¼˜åŒ–ã€å¼‚æ­¥å¤„ç†

---

## 6. æŠ€æœ¯åˆ†å·¥ç­–ç•¥

### 6.1 æ ¸å¿ƒåŸåˆ™

å¤æ‚å•æ®å¯¼å…¥åŠŸèƒ½åº”é‡‡ç”¨ **"ç®—æ³•åœ¨åç«¯ï¼Œäº¤äº’åœ¨å‰ç«¯"** çš„æ··åˆæ¨¡å¼ï¼š

- **Cursor (FastAPI)**: å®ç°æ ¸å¿ƒç®—æ³•å’Œæ•°æ®å¤„ç†é€»è¾‘
- **Lovable (Edge Functions + Frontend)**: å®ç°ç”¨æˆ·äº¤äº’ç•Œé¢å’Œè½»é‡çº§ä¸šåŠ¡é€»è¾‘

### 6.2 Cursor è´Ÿè´£ï¼ˆFastAPIåç«¯ï¼‰

#### æ ¸å¿ƒç®—æ³•å®ç°

1. **æ ¼å¼è¯†åˆ«ç®—æ³•**
   - æ–‡æ¡£æ ¼å¼è‡ªåŠ¨æ£€æµ‹ï¼ˆ6ç§æ ¼å¼è¯†åˆ«ï¼‰
   - å­—æ®µç±»å‹å’Œç»“æ„åˆ†æ
   - æ¨¡å¼åŒ¹é…å’Œç‰¹å¾æå–

2. **å­—æ®µæ˜ å°„ç®—æ³•**
   - æ™ºèƒ½å­—æ®µæ˜ å°„æ¨è
   - å­—æ®µç›¸ä¼¼åº¦è®¡ç®—ï¼ˆLevenshteinè·ç¦»ã€è¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
   - å†å²æ˜ å°„è®°å½•æŸ¥è¯¢

3. **ä¸»æ•°æ®åŒ¹é…ç®—æ³•**
   - ä¸»æ•°æ®IDè‡ªåŠ¨åŒ¹é…ï¼ˆ7ç§ä¸»æ•°æ®ç±»å‹ï¼‰
   - å•å­—æ®µå’Œç»„åˆå­—æ®µåŒ¹é…
   - æ¨¡ç³ŠåŒ¹é…å’Œç²¾ç¡®åŒ¹é…
   - ç½®ä¿¡åº¦è®¡ç®—

4. **å•æ®å¤´IDåŒ¹é…ç®—æ³•**
   - é€šè¿‡å•æ®å·åŒ¹é…ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„å•æ®å¤´è®°å½•ID
   - åŒ¹é…ç»“æœéªŒè¯

5. **æ•°æ®å¤„ç†ç®—æ³•**
   - å‰å‘å¡«å……ï¼ˆæ ¼å¼2ï¼‰
   - æ•°æ®åˆå¹¶å’Œå…³è”
   - è™šæ‹Ÿè®°å½•ç”Ÿæˆ

#### APIç«¯ç‚¹

**æ ¸å¿ƒå¤„ç†ç«¯ç‚¹**ï¼š
- `POST /api/v1/data-import/analyze` - åˆ†ææ–‡ä»¶ç»“æ„ï¼Œæ¨èå­—æ®µæ˜ å°„
- `POST /api/v1/data-import/process` - å¤„ç†å¤æ‚å•æ®æ ¼å¼
- `POST /api/v1/data-import/validate` - æ·±åº¦æ•°æ®éªŒè¯

**åŒ¹é…å’Œå†³ç­–ç«¯ç‚¹**ï¼š
- `POST /api/v1/data-import/match-master-data` - ä¸»æ•°æ®åŒ¹é…ï¼ˆæ‰¹é‡ï¼‰
- `POST /api/v1/data-import/match-document-header` - å•æ®å¤´IDåŒ¹é…
- `POST /api/v1/data-import/match-status` - è·å–åŒ¹é…çŠ¶æ€å’Œå¾…å†³ç­–é¡¹

**ç”¨æˆ·å†³ç­–ç«¯ç‚¹**ï¼š
- `POST /api/v1/data-import/confirm-match` - ç¡®è®¤åŒ¹é…å†³ç­–
- `POST /api/v1/data-import/confirm-mappings` - ç¡®è®¤å­—æ®µæ˜ å°„
- `POST /api/v1/data-import/reject-mapping` - æ‹’ç»æ˜ å°„

**ä¸‰é˜¶æ®µå¯¼å…¥ç«¯ç‚¹**ï¼š
- `POST /api/v1/data-import/stage1-import` - é˜¶æ®µ1ï¼šå¯¼å…¥ä¸´æ—¶è¡¨
- `POST /api/v1/data-import/stage2-batch-fix` - é˜¶æ®µ2ï¼šæ‰¹é‡ä¿®æ­£
- `POST /api/v1/data-import/stage3-confirm-import` - é˜¶æ®µ3ï¼šç¡®è®¤å¯¼å…¥æ­£å¼è¡¨

### 6.3 Lovable è´Ÿè´£ï¼ˆEdge Functions + Frontendï¼‰

#### ç”¨æˆ·äº¤äº’ç•Œé¢

1. **å­—æ®µæ˜ å°„ç•Œé¢**
   - å±•ç¤ºæºå­—æ®µå’Œç›®æ ‡å­—æ®µæ˜ å°„å…³ç³»
   - ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´æ˜ å°„
   - ç¡®è®¤æ˜ å°„ç»“æœ

2. **æ ¼å¼è¯†åˆ«å±•ç¤º**
   - æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æ ¼å¼ç±»å‹
   - æ ¼å¼ç½®ä¿¡åº¦å±•ç¤º
   - ç”¨æˆ·ç¡®è®¤æˆ–æ‰‹åŠ¨é€‰æ‹©æ ¼å¼

3. **åŒ¹é…å†³ç­–ç•Œé¢**
   - ä¸»æ•°æ®åŒ¹é…ç»“æœå±•ç¤ºï¼ˆå¤šä¸ªå€™é€‰ï¼‰
   - å•æ®å¤´åŒ¹é…ç»“æœå±•ç¤º
   - ç”¨æˆ·é€‰æ‹©æ“ä½œï¼šé€‰æ‹©ã€åˆ›å»ºæ–°ã€åºŸå¼ƒ
   - æ‰¹é‡å†³ç­–æ”¯æŒ

4. **é—®é¢˜ä¿®æ­£ç•Œé¢**
   - ä¸´æ—¶è¡¨é—®é¢˜åˆ—è¡¨
   - æ‰¹é‡/é€æ¡å¤„ç†ç•Œé¢
   - ä¿®æ­£ç»“æœé¢„è§ˆ

#### è½»é‡çº§ä¸šåŠ¡é€»è¾‘ï¼ˆEdge Functionsï¼‰

- ç®€å•éªŒè¯
- çŠ¶æ€ç®¡ç†
- æ•°æ®å†™å…¥ï¼ˆç®€å•åœºæ™¯ï¼‰

---

## 7. APIæ¥å£è®¾è®¡

### 7.1 æ–‡ä»¶åˆ†ææ¥å£

```http
POST /api/v1/data-import/analyze
Content-Type: multipart/form-data

{
  "file": <file>,
  "source_type": "purchase_order|sales_order|...",
  "source_system": "erp_system_a",
  "document_type": "purchase_order"
}
```

**å“åº”**:
```json
{
  "document_format": "excel",
  "detected_format_type": "repeated_header|first_row_header|...",
  "format_confidence": 0.95,
  "field_mappings": [
    {
      "source_field": "é‡‡è´­å•å·",
      "target_field": "å•æ®å·",
      "confidence": 0.98,
      "match_type": "history",
      "method": "å†å²æ˜ å°„ï¼ˆ15æ¬¡ä½¿ç”¨ï¼‰"
    }
  ],
  "suggested_mappings": [...],
  "warnings": [...]
}
```

### 7.2 å­—æ®µæ˜ å°„æ¨èæ¥å£

```http
POST /api/v1/data-import/recommend-mappings
Content-Type: application/json

{
  "source_fields": ["é‡‡è´­è®¢å•å·", "è®¢å•æ—¥æœŸ", "ä¾›åº”å•†", ...],
  "source_system": "erp_system_a",
  "document_type": "purchase_order",
  "user_id": "uuid"
}
```

### 7.3 é˜¶æ®µ1ï¼šå¯¼å…¥ä¸´æ—¶è¡¨æ¥å£

```http
POST /api/v1/data-import/stage1-import
Content-Type: application/json

{
  "file_id": "uuid",
  "field_mappings": {...},
  "format_type": "repeated_header",
  "metadata": {...}
}
```

**å“åº”**:
```json
{
  "batch_id": "uuid",
  "imported_count": 100,
  "problem_count": 15,
  "auto_matched_count": 85,
  "status": "completed",
  "problems": [
    {
      "row_index": 5,
      "problem_type": "no_master_match",
      "problem_description": "äº§å“'XXX'æœªæ‰¾åˆ°åŒ¹é…è®°å½•",
      "requires_user_action": true
    }
  ]
}
```

### 7.4 é˜¶æ®µ2ï¼šæ‰¹é‡ä¿®æ­£æ¥å£

```http
POST /api/v1/data-import/stage2-batch-fix
Content-Type: application/json

{
  "batch_id": "uuid",
  "actions": [
    {
      "row_id": "uuid",
      "action_type": "select|create_new|skip|fix_calculation",
      "action_details": {
        "selected_id": 123,
        "new_data": {...},
        "fixed_fields": {...}
      }
    }
  ]
}
```

### 7.5 é˜¶æ®µ3ï¼šç¡®è®¤å¯¼å…¥æ¥å£

```http
POST /api/v1/data-import/stage3-confirm-import
Content-Type: application/json

{
  "batch_id": "uuid",
  "validate_before_import": true
}
```

---

## 8. æ•°æ®åº“è®¾è®¡

### 8.1 æ ¸å¿ƒè¡¨ç»“æ„

**å­—æ®µæ˜ å°„å†å²è¡¨**ï¼ˆè§ç¬¬2.4èŠ‚ï¼‰

**å­—æ®µæ˜ å°„è§„åˆ™è¡¨**ï¼ˆè§ç¬¬2.4èŠ‚ï¼‰

**ä¸´æ—¶å¯¼å…¥è¡¨**ï¼ˆè§ç¬¬5.2èŠ‚ï¼‰

### 8.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- å­—æ®µæ˜ å°„å†å²è¡¨ç´¢å¼•
CREATE INDEX idx_field_mapping_context ON field_mapping_history(source_system, document_type, user_id);
CREATE INDEX idx_field_mapping_source ON field_mapping_history(source_field_name);
CREATE INDEX idx_field_mapping_usage ON field_mapping_history(usage_count DESC, last_used_at DESC);

-- ä¸´æ—¶å¯¼å…¥è¡¨ç´¢å¼•
CREATE INDEX idx_staging_batch ON staging_document_import(batch_id);
CREATE INDEX idx_staging_status ON staging_document_import(status);
CREATE INDEX idx_staging_requires_action ON staging_document_import(requires_user_action);
CREATE INDEX idx_staging_document_number ON staging_document_import(document_number);
```

---

## 9. æ€»ç»“å’Œå®æ–½å»ºè®®

### 9.1 æ ¸å¿ƒç‰¹æ€§æ€»ç»“

âœ… **æ™ºèƒ½å­—æ®µæ˜ å°„**: è‡ªåŠ¨æ¨èå­—æ®µæ˜ å°„ï¼Œè®°å½•å†å²æ˜ å°„ï¼ŒæŒç»­å­¦ä¹ æé«˜å‡†ç¡®æ€§  
âœ… **æ™ºèƒ½æ ¼å¼è¯†åˆ«**: è‡ªåŠ¨æ£€æµ‹6ç§å¤æ‚å•æ®æ ¼å¼ï¼Œä¼˜å…ˆæ”¯æŒå¸¸è§æ ¼å¼ï¼ˆæ ¼å¼1/2/4/6ï¼‰  
âœ… **ä¸»æ•°æ®è‡ªåŠ¨åŒ¹é…**: æ”¯æŒ7ç§ä¸»æ•°æ®IDçš„è‡ªåŠ¨åŒ¹é…ï¼Œæ”¯æŒç²¾ç¡®å’Œæ¨¡ç³ŠåŒ¹é…  
âœ… **ç”¨æˆ·å†³ç­–æœºåˆ¶**: åœ¨å…³é”®å†³ç­–ç‚¹æ”¯æŒç”¨æˆ·é€‰æ‹©ï¼ˆé€‰æ‹©ã€åˆ›å»ºæ–°ã€åºŸå¼ƒï¼‰  
âœ… **ä¸‰é˜¶æ®µå¯¼å…¥**: ä¸´æ—¶è¡¨éš”ç¦»ã€é—®é¢˜ä¿®æ­£ã€æ­£å¼è¡¨å¯¼å…¥ï¼Œä¿è¯æ•°æ®å®‰å…¨  
âœ… **è®¡ç®—å­—æ®µéªŒè¯**: éªŒè¯ä»·ç¨åˆè®¡ = ä¸å«ç¨é‡‘é¢ + ç¨é¢çš„ä¸€è‡´æ€§  
âœ… **ç¨åŠ¡å­—æ®µæ”¯æŒ**: å®Œæ•´æ”¯æŒä¸å«ç¨é‡‘é¢ã€ç¨é¢ã€ä»·ç¨åˆè®¡ç­‰ç¨åŠ¡å­—æ®µ  

### 9.2 å®æ–½ä¼˜å…ˆçº§

**ä¼˜å…ˆçº§1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»å®ç°ï¼‰**
1. âœ… å­—æ®µæ˜ å°„æ¨èå’Œå†å²è®°å½•
2. âœ… æ ¼å¼1ã€æ ¼å¼2ã€æ ¼å¼4ã€æ ¼å¼6å¤„ç†å™¨
3. âœ… ä¸»æ•°æ®åŒ¹é…ç®—æ³•ï¼ˆ7ç§ä¸»æ•°æ®ï¼‰
4. âœ… ä¸´æ—¶è¡¨ç»“æ„å’Œå¯¼å…¥é€»è¾‘
5. âœ… ç”¨æˆ·ä¿®æ­£ç•Œé¢ï¼ˆæ‰¹é‡/é€æ¡ï¼‰

**ä¼˜å…ˆçº§2ï¼šå¢å¼ºåŠŸèƒ½ï¼ˆæ¨èå®ç°ï¼‰**
6. â³ æ ¼å¼5å¤„ç†å™¨ï¼ˆè¡¥å……æ˜ç»†æ—¶ï¼‰
7. â³ è®¡ç®—å­—æ®µå†²çªæ£€æµ‹å’Œçº æ­£
8. â³ è‡ªåŠ¨æ¸…ç†æœºåˆ¶
9. â³ æ€§èƒ½ä¼˜åŒ–

**ä¼˜å…ˆçº§3ï¼šå¯é€‰åŠŸèƒ½**
10. â³ æ ¼å¼3å¤„ç†å™¨ï¼ˆå¯å¿½ç•¥ï¼‰
11. â³ é«˜çº§æ•°æ®è´¨é‡åˆ†æ
12. â³ åä½œå¤„ç†åŠŸèƒ½

### 9.3 æŠ€æœ¯åˆ†å·¥

**Cursorçš„äº¤ä»˜ç‰©** âœ…:
- [x] ç®—æ³•è®¾è®¡å’Œå®ç°ï¼ˆå­—æ®µæ˜ å°„ã€æ ¼å¼è¯†åˆ«ã€ä¸»æ•°æ®åŒ¹é…ï¼‰
- [x] APIç«¯ç‚¹å¼€å‘
- [x] æ•°æ®åº“è®¾è®¡
- [x] å®Œæ•´è®¾è®¡æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰

**Lovableçš„å®æ–½ä»»åŠ¡** â³:
- [ ] å‰ç«¯ç•Œé¢å¼€å‘ï¼ˆå­—æ®µæ˜ å°„ã€æ ¼å¼å±•ç¤ºã€åŒ¹é…å†³ç­–ã€é—®é¢˜ä¿®æ­£ï¼‰
- [ ] Edge Functionsè½»é‡çº§é€»è¾‘
- [ ] ç”¨æˆ·äº¤äº’æµç¨‹å®ç°
- [ ] UI/UXä¼˜åŒ–

### 9.4 é¢„è®¡å®æ–½æ—¶é—´

- **æ ¸å¿ƒåŠŸèƒ½**: 2-3å‘¨
- **å¢å¼ºåŠŸèƒ½**: 1-2å‘¨
- **ä¼˜åŒ–å’Œæµ‹è¯•**: 1å‘¨

**æ€»è®¡**: 4-6å‘¨

---

## ğŸ“š é™„å½•

### A. æ ‡å‡†å­—æ®µåæ¸…å•

**å•æ®å¤´å­—æ®µ**ï¼š
- å•æ®å· (document_id)
- å•æ®æ—¥æœŸ (document_date)
- å®¢æˆ·åç§° (customer_name)
- ä¸å«ç¨é‡‘é¢ (ex_tax_amount)
- ç¨é¢ (tax_amount)
- ä»·ç¨åˆè®¡ (total_amount_with_tax)

**æ˜ç»†å­—æ®µ**ï¼š
- äº§å“åç§° (product_name)
- æ•°é‡ (quantity)
- å•ä»· (unit_price)
- ä¸å«ç¨é‡‘é¢ (ex_tax_amount)
- ç¨é¢ (tax_amount)
- ä»·ç¨åˆè®¡ (total_amount_with_tax)
- ç¨ç‡ (tax_rate)

### B. é—®é¢˜ç±»å‹æšä¸¾

- `no_master_match`: ä¸»æ•°æ®æœªæ‰¾åˆ°åŒ¹é…
- `multiple_master_match`: ä¸»æ•°æ®å¤šä¸ªåŒ¹é…å€™é€‰
- `low_confidence_match`: ä¸»æ•°æ®åŒ¹é…ç½®ä¿¡åº¦ä½
- `no_document_header_match`: å•æ®å¤´æœªæ‰¾åˆ°åŒ¹é…ï¼ˆæ ¼å¼5ï¼‰
- `calculation_conflict`: è®¡ç®—å­—æ®µå†²çª
- `missing_required_field`: å¿…å¡«å­—æ®µç¼ºå¤±
- `invalid_data_type`: æ•°æ®ç±»å‹é”™è¯¯
- `out_of_range`: æ•°æ®è¶…å‡ºèŒƒå›´

### C. çŠ¶æ€æšä¸¾

**ä¸´æ—¶è¡¨çŠ¶æ€**ï¼š
- `pending`: å¾…å¤„ç†
- `matched`: å·²åŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦è‡ªåŠ¨åŒ¹é…ï¼‰
- `problem`: æœ‰é—®é¢˜ï¼Œéœ€è¦ç”¨æˆ·å¤„ç†
- `confirmed`: å·²ç¡®è®¤ï¼Œå‡†å¤‡å¯¼å…¥æ­£å¼è¡¨
- `imported`: å·²å¯¼å…¥æ­£å¼è¡¨
- `rejected`: å·²åºŸå¼ƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2025-01-23  
**ç»´æŠ¤è€…**: Cursor (ç®—æ³•è®¾è®¡ä¸æŠ€æœ¯æ¶æ„)

